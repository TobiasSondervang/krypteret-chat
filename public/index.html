<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Krypteret Chat med Mapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Login sektion -->
    <div id="loginSection">
        <h1>Log ind eller Opret bruger</h1>
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Adgangskode"><br>
        <button onclick="signUp()">Opret bruger</button>
        <button onclick="signIn()">Log ind</button>
        <p id="loginMessage"></p>
    </div>

    <!-- Chat sektion -->
    <div id="chatSection" class="hidden">
        <h1>Privat Krypteret Chat</h1>
        <button onclick="signOut()">Log ud</button><br>
        <p>Logget ind som: <span id="userEmail"></span></p>

        <h3>Send en besked</h3>
        <input type="email" id="recipientEmail" placeholder="Modtagerens email"><br>
        <textarea id="message" rows="4" cols="50" placeholder="Skriv din besked"></textarea><br>
        <input type="text" id="key" placeholder="Hemmelig nøgle (del med modtager)"><br>
        <button onclick="sendMessage()">Send Besked</button>

        <h3>Dine mapper</h3>
        <input type="text" id="folderName" placeholder="Ny mappe"><br>
        <button onclick="createFolder()">Opret Mappe</button><br>
        <select id="folderSelect">
            <option value="">Vælg mappe</option>
        </select>

        <h3>Dine chats</h3>
        <button onclick="loadChats()">Opdater Chats</button>
        <div id="chatBox"></div>
    </div>

    <script>
        let currentUser = null;

        function signUp() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            fetch('/.netlify/functions/login', {
                method: 'POST',
                body: JSON.stringify({ email, password, action: 'signup' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentUser = email;
                    showChat();
                } else {
                    document.getElementById("loginMessage").textContent = data.message;
                }
            });
        }

        function signIn() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            fetch('/.netlify/functions/login', {
                method: 'POST',
                body: JSON.stringify({ email, password, action: 'signin' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentUser = email;
                    showChat();
                } else {
                    document.getElementById("loginMessage").textContent = data.message;
                }
            });
        }

        function signOut() {
            currentUser = null;
            document.getElementById("chatSection").classList.add("hidden");
            document.getElementById("loginSection").classList.remove("hidden");
        }

        function showChat() {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("chatSection").classList.remove("hidden");
            document.getElementById("userEmail").textContent = currentUser;
            loadChats();
            loadFolders();
        }

        function sendMessage() {
            const recipientEmail = document.getElementById("recipientEmail").value;
            const message = document.getElementById("message").value;
            const key = document.getElementById("key").value;

            if (!recipientEmail || !message || !key) {
                alert("Udfyld alle felter!");
                return;
            }

            const encrypted = CryptoJS.AES.encrypt(message, key).toString();

            fetch('/.netlify/functions/sendMessage', {
                method: 'POST',
                body: JSON.stringify({
                    sender: currentUser,
                    recipient: recipientEmail,
                    encryptedMessage: encrypted
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("message").value = "";
                    loadChats();
                }
            });
        }

        function createFolder() {
            const folderName = document.getElementById("folderName").value;
            if (!folderName) {
                alert("Indtast et mappenavn!");
                return;
            }

            fetch('/.netlify/functions/manageFolders', {
                method: 'POST',
                body: JSON.stringify({ user: currentUser, folderName, action: 'create' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("folderName").value = "";
                    loadFolders();
                }
            });
        }

        function saveToFolder(messageId) {
            const folderName = document.getElementById("folderSelect").value;
            if (!folderName) {
                alert("Vælg en mappe!");
                return;
            }

            fetch('/.netlify/functions/manageFolders', {
                method: 'POST',
                body: JSON.stringify({ user: currentUser, folderName, messageId, action: 'save' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Besked gemt i mappe!");
                }
            });
        }

        function loadFolders() {
            fetch('/.netlify/functions/manageFolders', {
                method: 'GET',
                headers: { 'X-User-Email': currentUser }
            })
            .then(response => response.json())
            .then(data => {
                const folderSelect = document.getElementById("folderSelect");
                folderSelect.innerHTML = '<option value="">Vælg mappe</option>';
                data.folders.forEach(folder => {
                    const option = document.createElement("option");
                    option.value = folder.name;
                    option.textContent = folder.name;
                    folderSelect.appendChild(option);
                });
            });
        }

        function loadChats() {
            fetch('/.netlify/functions/sendMessage', {
                method: 'GET',
                headers: { 'X-User-Email': currentUser }
            })
            .then(response => response.json())
            .then(data => {
                const chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = "";
                data.messages.forEach((msg, index) => {
                    const messageDiv = document.createElement("div");
                    messageDiv.className = "message";
                    messageDiv.innerHTML = `
                        <p>Fra: ${msg.sender}</p>
                        <p>Krypteret: ${msg.encryptedMessage}</p>
                        <input type="text" placeholder="Indtast nøgle" id="key-${index}">
                        <button onclick="decryptMessage('${msg.encryptedMessage}', 'key-${index}')">Dekrypter</button>
                        <button onclick="saveToFolder('${msg.id}')">Gem i mappe</button>
                        <p id="decrypted-${index}"></p>
                    `;
                    chatBox.appendChild(messageDiv);
                });
            });
        }

        function decryptMessage(encrypted, keyId) {
            const key = document.getElementById(keyId).value;
            const decrypted = CryptoJS.AES.decrypt(encrypted, key).toString(CryptoJS.enc.Utf8);
            document.getElementById(`decrypted-${keyId.split('-')[1]}`).textContent = decrypted || "Fejl: Ugyldig nøgle";
        }
    </script>
</body>
</html>